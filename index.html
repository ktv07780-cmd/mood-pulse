<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMO-PULSE 2026 | Global Tracker</title>
   <!-- === –ü–û–õ–ù–´–ï –°–°–´–õ–ö–ò –ù–ê –ë–ò–ë–õ–ò–û–¢–ï–ö–ò === -->
	<script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
	<script src="https://unpkg.com/globe.gl@2.34.0/dist/globe.gl.min.js"></script>
	<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
	<link rel="stylesheet" href="emo-pulse.css">

</head>

<body>

<div class="ui top">
    <div class="panel">
        <div>1. –°–¢–ê–¢–£–° / STATUS</div>
        <button onclick="setMode('here', this)">üìç –Ø –¢–£–¢</button>
        <button onclick="setMode('focus', this)">üí≠ –î–£–ú–ê–Æ</button>

        <!-- ADDED: –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤ -->
        <hr style="opacity:.3">
        <label style="display:block; text-align:left;">
            <input type="checkbox" onchange="toggleContinents(this.checked)">
            üåç –ö–æ–Ω—Ç–∏–Ω–µ–Ω—Ç—ã
        </label>
        <label style="display:block; text-align:left;">
            <input type="checkbox" onchange="toggleGrid(this.checked)">
            üß≠ –°–µ—Ç–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        </label>
    </div>
</div>

<div id="globeViz"></div>

<div class="ui bottom" id="action-panel" style="display:none;">
    <div class="panel">
        <div id="instr">2. –ö–õ–ò–ö–ù–ò–¢–ï –ù–ê –®–ê–†</div>
        <div id="emotions" style="display:none;">
            <button style="color:#00ff88" onclick="finish('joy')">–†–ê–î–û–°–¢–¨</button>
            <button style="color:#ff4444" onclick="finish('anger')">–ì–ù–ï–í</button>
        </div>
    </div>
</div>

<script>
/* === –¥–∞–Ω–Ω—ã–µ –∏–∑ Supabase (Settings -> API) === */
const SB_URL = 'https://yhlshbefcjfzzripqlzo.supabase.co';
const SB_KEY = 'sb_publishable_PVX1Hgt9KyL0r8o7DRbNAQ_gj0ixPeM';

/* === –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É Supabase === */
const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

let state = {
    mode: null,
    lat: null,
    lng: null
};

/* === –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–∏–Ω–µ–Ω—Ç–æ–≤ === */
const continents = [
    { name: 'North America', lat: 54, lng: -105 },
    { name: 'South America', lat: -15, lng: -60 },
    { name: 'Europe', lat: 50, lng: 15 },
    { name: 'Africa', lat: 5, lng: 20 },
    { name: 'Asia', lat: 40, lng: 90 },
    { name: 'Australia', lat: -25, lng: 135 },
    { name: 'Antarctica', lat: -80, lng: 0 }
];

/* === —Å–æ–∑–¥–∞–Ω–∏–µ –≥–ª–æ–±—É—Å–∞ === */
const world = Globe()
(document.getElementById('globeViz'))
    .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-dark.jpg')
    .backgroundColor('#000')
    .onGlobeClick(({ lat, lng }) => {
        if (!state.mode) return;
        state.lat = lat;
        state.lng = lng;
        document.getElementById('instr').style.display = 'none';
        document.getElementById('emotions').style.display = 'block';
    });

world.controls().autoRotate = true;
world.controls().autoRotateSpeed = 0.6;

/* === —Å–Ω–µ–∂–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞ –ø–æ–ª—é—Å–∞—Ö === */
const polarSnowPoints = [];

// —Å–µ–≤–µ—Ä–Ω—ã–π –ø–æ–ª—é—Å: —à–∏—Ä–æ—Ç–∞ 75¬∞‚Äì90¬∞
for(let lat = 75; lat <= 90; lat += 1){
    for(let lng = -180; lng < 180; lng += 10){
        polarSnowPoints.push({
            lat, lng,
            size: 0.3 + Math.random()*0.2,  // —Ä–∞–∑–Ω–∞—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞
            color: `rgba(255,255,255,${0.1 + Math.random()*0.3})` // –ø–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
        });
    }
}

// —é–∂–Ω—ã–π –ø–æ–ª—é—Å: —à–∏—Ä–æ—Ç–∞ -75¬∞‚Äì-90¬∞
for(let lat = -90; lat <= -75; lat += 1){
    for(let lng = -180; lng < 180; lng += 10){
        polarSnowPoints.push({
            lat, lng,
            size: 0.3 + Math.random()*0.2,
            color: `rgba(255,255,255,${0.1 + Math.random()*0.3})`
        });
    }
}

// –¥–æ–±–∞–≤–ª—è–µ–º –Ω–∞ globe
world.pointsData(polarSnowPoints)
     .pointLat(d => d.lat)
     .pointLng(d => d.lng)
     .pointColor(d => d.color)
     .pointAltitude(0.01)
     .pointRadius(d => d.size);

/* === UI === */
function setMode(m, el) {
    state.mode = m;
    document.querySelectorAll('.top button')
        .forEach(b => b.classList.remove('selected'));
    el.classList.add('selected');
    document.getElementById('action-panel').style.display = 'flex';
}

/* –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–∏–Ω–µ–Ω—Ç–æ–≤ */
function toggleContinents(enabled) {
    if (enabled) {
        world
          .labelsData(continents)
          .labelLat(d => d.lat)
          .labelLng(d => d.lng)
          .labelText(d => d.name)
          .labelSize(1.1)
          .labelDotRadius(0.5)
          .labelColor(() => 'rgba(255,255,255,0.9)')
          .labelResolution(2);
    } else {
        world.labelsData([]);
    }
}

/* –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–µ—Ç–∫–∏ */
function toggleGrid(enabled) {
    world.graticulesData(enabled ? [{}] : []);
}

/* === SEND DATA === */
async function finish(emotion) {
    const payload = {
        emotion: emotion,
        presence_type: state.mode,
        lat: state.lat,
        lng: state.lng,
        os: navigator.platform,
        browser: navigator.userAgent,
        lang: navigator.language,
        fingerprint: btoa(navigator.userAgent).slice(0,16)
    };

    const { error } = await supabaseClient
        .from('world_mood_data')
        .insert([payload]);

    if (!error) {
        alert('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
        location.reload();
    } else {
        console.error(error);
        alert('–û—à–∏–±–∫–∞ Supabase (–ø—Ä–æ–≤–µ—Ä—å —Ç–∞–±–ª–∏—Ü—É / RLS)');
    }
}
</script>

</body>
</html>
